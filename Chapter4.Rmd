# 4. 介入効果の推定  
ここでは、いよいよ相関関係と因果関係をきちんと見分け、原因を変化させたときに結果に与える効果(**因果効果・介入効果**)の大きさを推定するための方法を学ぶ。  

これまで見てきたように、変数間に相関関係があるからと言って、因果関係があるとは限らない場合が多々ある。よって、**相関関係から予測される効果**が**実際の介入効果(因果効果)**とズレることがよく起こる。  

例えば、あなたは河川中の汚染物質量が底生昆虫の種数に与える影響を知るため、データを収集したとする。その結果、図\@ref(fig:fig-cor)のようなデータが得られた($X$: 河川中の汚染物質の量, $Y$: 底生昆虫の種数)。このデータだけをもとに、「底生昆虫の種数を増やすためには、河川中の汚染物質を減らすべきだ」と結論付けることはできるだろうか？  

答えはノーである。あくまでもこのデータから言えるのは、「$X$が小さいほど$Y$は大きい」ということだけであり、これは**相関関係**の話である。あなたが本当に知りたいのは「$X$を**<u>小さくしたときに</u>、$Y$**が大きくなる**」といえるかである。  

```{r, echo = FALSE}
N <- 100
Z <- rep(c(0,1),each = N/2)
X <- rnorm(N, 20 - 12*Z,4)
Y <- rnorm(N, 10 + 7*Z, 2.5)
d <- tibble(X =X, Y=Y,Z=Z)
```

```{r fig-cor, echo = FALSE, fig.cap = "河川中の汚染物質量と底生昆虫の種数の関係",fig.dim = c(3,3)}
ggplot(d,aes(x=X,y=Y))+
  geom_point()+
  geom_smooth(method = "lm", se = F, color = "grey")+
  theme_bw(base_size = 12)+
  theme(aspect.ratio = 1)
```

例えば、各データが川の上流域/下流域のいずれで収集されたかも記録し、図\@ref(fig:fig-cor2)のような結果が得られたとする。このグラフから、データを上流/下流で収集するかが$X$と$Y$の両方に独立に影響したことで、$X$と$Y$の相関が生じた可能性が示唆される(交絡要因の影響)。このように、$X$と$Y$の相関が$X$と関係ない要因で生じているなら、$X$を変化させても$Y$は変化しないだろう。  

```{r fig-cor2, echo = FALSE, fig.cap = "データ収集場所の情報も含めた河川中の汚染物質量と底生昆虫の種数の関係",fig.dim = c(4,3)}
d %>% 
  mutate(Z = str_replace_all(Z, c("1" = "下流域","0"="上流域"))) %>% 
  ggplot(aes(x=X,y=Y))+
  geom_point(aes(color = Z))+
  geom_smooth(aes(color = Z), method = "lm", se = F, color = "grey")+
  theme_bw(base_size = 12)+
  theme(aspect.ratio = 1)+
  labs(color = "")
```

図\@ref(fig:fig-cor3)のように、$Y$はデータ収集場所の影響もうけるが、それに加えて$X$の影響も部分的に受けているということもあるかもしれない(上流域/下流域それぞれでも$X$と$Y$に相関がある)。その場合、$X$を変化させれば$Y$も部分的に変化する。    
```{r, echo = FALSE}
N <- 100
Z <- rep(c(0,1),each = N/2)
X <- rnorm(N, 20 - 12*Z,4)
Y <- rnorm(N, 10 + 2.5*Z - 0.7*X, 3.5)
d2 <- tibble(X =X, Y=Y,Z=Z)
```

```{r fig-cor3, echo = FALSE,fig.cap = "データ収集場所の情報も含めた河川中の汚染物質量と底生昆虫の種数の関係2",fig.dim = c(4,3)}
d2 %>% 
  mutate(Z = str_replace_all(Z, c("1" = "下流域","0"="上流域"))) %>% 
  ggplot(aes(x=X,y=Y))+
  geom_point(aes(color = Z))+
  geom_smooth(aes(color = Z),method = "lm", se = F, color = "grey")+
  theme_bw(base_size = 12)+
  theme(aspect.ratio = 1)+
  labs(color = "")
```

このように、$X$の介入効果を推定するためには、$Y$**の値がどのような過程で得られるのかに大きく依存**するのである。  

介入効果を推定するために良く用いられる方法は、**ランダム化比較試験(RCT)**である。この方法では、応答(反応)変数($Y$)に影響を与える因子は、1つ($X$)を除いて固定されるか、ランダム化される。このようなとき、$Y$の変化は$X$によってのみ生じたといえるので、$X$の介入効果を正確に推定できる。  

しかし、実際の研究ではRCTを行うことは不可能であることが多い(金銭的・時間的・倫理的・方法論的問題などなど...)。そのような場合、研究者は代わりにこうした操作を行わない観察研究を行うことになるが、近年の統計学の発展により、**観察研究であっても適切に分析を行えば介入効果を推定できる**ことが分かってきた。以下では、前章までに学んだことをもとに、どうすれば観察研究でも介入効果を正確に推定できるのかを学んでいく。  

## 4.1 介入とは    
モデルにおいてある変数に「介入する」とは、その変数をある値に固定することを意味する($\neq$条件付けする)。よって、しばしば他の変数の値も変化する。一方で、値を固定するので、**他の変数からの影響はなくなる**。  

グラフでは、$X$に介入するということは、$X$に向かう辺が全て取り除かれることを表す(図\@ref(fig:fig-kainyu)のAからBに変化するように)。このことからも、$X$で条件するときとは変数間の関係が全く違くなることが分かる。$X$にある変数に介入する際の手順は、因果グラフの構造により異なる。      

**ひとことメモ**  
$X$以外をランダム化することも、$X$へ向かう辺をすべて取り除くことに相当する。  
```{r fig-kainyu, fig.cap = "Xに介入したときのグラフの変化", echo = FALSE,fig.dim = c(4.5,2.8)}
dag10 <- tibble(name = c("X","Ux","Z","Uz","Y","Uy"),
               x = c(1,1,2,2,3,3),
               y = c(1,1.5,1.5,2,1,1.5))

dagify(X ~ Ux + Z,
       Z ~ Uz,
       Y ~ Uy + X + Z,
       coords = dag10) %>% 
  ggdag(node_size =10, text_size = 3)+
  theme_dag()+
  labs(title = "A")-> p_dag1

dag11 <- tibble(name = c("X","Z","Uz","Y","Uy"),
               x = c(1,2,2,3,3),
               y = c(1,1.5,2,1,1.5))

dagify(X ~ X,
       Z ~ Uz,
       Y ~ Uy + X + Z,
       coords = dag11) %>% 
  ggdag(node_size =10, text_size = 3)+
  theme_dag()+
  labs(title = "B") -> p_dag2


p_dag1 + p_dag2
```

条件付き確率($P(Y = y|X = x)$)と区別するため、$X$をある値$x$に固定(= $X$に介入)したときに$Y = y$になる確率は、以下のように書く。  
$do$表記と因果ダイアグラムを用いることで、グラフが現実を正確に表現していれば、観察データのみから介入効果を推定することができる。  

$$
P(Y = y|do(X = x))
$$


## 4.2 調整  
### 4.2.1 調整と調整化公式  
それでは、$P(Y = y|do(X = x))$はどのように求めたらよいだろうか。  
図\@ref(fig:fig-chousei)で、$Z$は性別、$X$は薬の投与の有無(0/1)、$Y$は回復の有無(0/1)を表すとする。  
```{r fig-chousei, fig.cap = "薬の効果を表す因果ダイアグラム", echo = FALSE,fig.dim = c(2.3,2.3)}
dag10 <- tibble(name = c("X","Ux","Z","Uz","Y","Uy"),
               x = c(1,1,2,2,3,3),
               y = c(1,1.5,1.5,2,1,1.5))

dagify(X ~ Ux + Z,
       Z ~ Uz,
       Y ~ Uy + X + Z,
       coords = dag10) %>% 
  ggdag(node_size =10, text_size = 3)+
  theme_dag()
```


患者全員に薬を投与する($do(X = 1$))という介入と、誰にも薬を投与しないという介入($do(X = 0$)との比較を考える。このとき、その差は因果効果差または平均因果効果(ACE: average causal effect)と呼ばれ、以下の式で表せる。$X$と$Y$が複数の値をとる場合は、すべての組み合わせついて効果を算出する。    

$$
P(Y = 1|do(X = 1)) - P(Y =1| do(X=0))
$$

因果効果$P(Y = y|do(X = x))$は、介入して$X$への辺を取り除いたモデル(図\@ref(fig:fig-chousei2))における条件付確率$P_m(Y=y|X=x)$に等しい[^foot1]。  

[^foot1]: 介入前と介入後のモデルにおける確立を区別するため、介入後のモデルの確立にはmを添え字として付す。  

```{r fig-chousei2, fig.cap = "介入後の因果ダイアグラム", echo = FALSE, fig.dim = c(2.3,2.3)}
dag11 <- tibble(name = c("X","Z","Uz","Y","Uy"),
               x = c(1,2,2,3,3),
               y = c(1,1.5,2,1,1.5))

dagify(X ~ X,
       Z ~ Uz,
       Y ~ Uy + X + Z,
       coords = dag11) %>% 
  ggdag(node_size =10, text_size = 3)+
  theme_dag()
```

また、介入前と介入後のグラフにおける確率について、以下の2点が成り立つ。    

1. $Z$を決める過程は$Z$から$X$への矢印がなくなっても変わらないので、周辺確率$P(Z = z)$は介入後も変化しない($P(Z=z) = P_m(Z=z)$)。  

2. $Y$が$X$と$Z$によって決まる過程(つまり$Y = f(x,y,u_y)$)は$X$への介入によって変わるわけではない。よって、条件付き確率$P(Y=y|X=x,Z=z) = P_m(Y=y|X=x,Z=z)$である。  

加えて、介入後のグラフで$X$と$Z$はd分離されて独立なので、$P_m(Z=z|X=x) = P_m(Z=z)$も成り立つ(3)。  

以上より、因果効果$P(Y=y|do(X=x))$は以下のように変形できる。  

$$
\begin{aligned}
  &P(Y=y|do(X=x))\\
  &= P_m(Y=y|X=x)\\
  &= \sum_{z}P_m(Y=y|X=x,Z=z)P_m(Z=z|X=x) (全確率の公式より)\\  
  &= \sum_{Z}P_m(Y=y|X=x,Z=z)P_m(Z=z) (1より)\\
  &= \sum_{z}P(Y=y|X=x,Z=z)P(Z=z) (2と3より)
\end{aligned}
$$

この式により、因果効果を介入前のグラフのデータから計算できるようになる。  
この式は**調整化公式**と呼ばれ、ある$Z$の値について$X$と$Y$の関係を計算し、それを$Z$について平均していることが分かる。このような処理を「$Z$**による調整**」または「$Z$についてのコントロール」と呼ぶ。  
  
**調整化公式の使用例**:   
図\@ref(fig:fig-chousei)のグラフについて、以下のデータ(表\@ref(tab:tab-chosei))が得られているとする。  

```{r tab-chosei, echo = FALSE}
data1 <- tribble(
  ~"",      ~"薬投与",             ~"薬投与なし", 
  "男性",   "81/87が回復(93%)",    "234/270が回復(87%)",
  "女性",    "192/263が回復(73%)", "55/80が回復(69%)",
  "全体",   "273/350が回復(78%)", "289/350が回復(83%)"
)

knitr::kable((data1), booktabs = TRUE,
caption = '薬の投与に関する結果')
```

このとき、平均因果効果(ACE)は以下のように求められる。なお、$X=1$は薬が投与されたこと、$Z=1$は患者が男であること、$Y=1$は患者が回復したことを表す。  
ACEは正の値なので、薬の効果があったことを示す。  

$$
\begin{aligned}
  &P(Y = 1| do(X = 1))\\
  &= P(Y=1|X=1,Z=1)P(Z=1) + P(Y=1|X=1,Z=0)P(Z=0) \\
  &= 0.93 \times \frac{87+270}{700} + 0.73 \times \frac{263+80}{700}\\
  &= 0.832\\
\end{aligned}
$$

$$
\begin{aligned}
  &P(Y = 1| do(X = 0))\\
  &= P(Y=1|X=0,Z=1)P(Z=1) + P(Y=1|X=0,Z=0)P(Z=0) \\
  &= 0.87 \times \frac{87+270}{700} + 0.69 \times \frac{263+80}{700}\\
  &= 0.7818\\
  \\
  &\therefore ACE = P(Y = 1| do(X = 1)) - P(Y = 1| do(X = 0))\\
  &= 0.832 - 0.7818 = 0.0502\\
\end{aligned}
$$

### 4.2.2 何を調整すべきか  
注意すべき点は、モデルの因果構造によって、調整すべき変数の集合$Z$が異なる点である。  
例えば、因果ダイアグラムが図\@ref(fig:fig-chosei3)のような事例を考える($X$: 薬の投与, $Y$: 回復, $Z$: 血圧)。  

```{r fig-chosei3, fig.cap = "薬の効果を表す因果ダイアグラム", echo = FALSE, fig.dim = c(2.3,2.3)}
dag12 <- tibble(name = c("X","Z","Y"),
               x = c(1,1.5,2),
               y = c(1,1.5,1))

dagify(Z ~ X,
       Y ~ X + Z,
       coords = dag12) %>% 
  ggdag(node_size =10, text_size = 3)+
  theme_dag()
```

このモデルについて、因果効果$P(Y = 1| do(X = 1))$を求めたいとする。このとき、$Z$で調整すべきだろうか？  
$X$への介入とは、$X$に向かう辺をすべて取り除くことであった。よって、もしこの因果ダイアグラムが正しいのであれば、$Z$で調整する必要はなく、以下の等式が成り立つ。  

$$
P(Y=1|do(X=1)) = P(Y=1|X=1)
$$

## 4.3 バックドア基準  
それでは、どの変数を変数の集合$Z$に含めて調整すれば因果効果を適切に吸い愛知できるだろうか。  
その基準として最も重要なものが**バックドア基準**である。
